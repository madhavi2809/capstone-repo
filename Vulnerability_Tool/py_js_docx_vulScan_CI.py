import os
import re
import sys
import docx

# Define text Colour
class Colour:
    GREEN = '\033[92m'
    RED = '\033[91m'
    BLUE = '\033[94m'
    YELLOW = '\033[93m'
    V_PATTERN_NAME = '\033[38;5;208m'  # Orange names
    NORMAL = '\033[0m'

# Define Vulnerability Patterns for JavaScript files
JS_Patterns = {
    "Sql_Injection": re.compile(r'\.query\s*\(.*\+.*\)'),
    "XSS": re.compile(r'res\.send\s*\(.*\+.*\)'),
    "Command_Injection": re.compile(r'exec\s*\(.*\+.*\)'),
    "insecure_file_handling": re.compile(r'fs\.unlink\s*\(.*\)'),
    "insecure_file_upload": re.compile(r'multer\s*\(\s*{.*dest.*}\s*\)'),
    "Eval_Function": re.compile(r'eval\s*\(.*\)'),
    "Directory_Movement": re.compile(r'fs\.readFile\s*\(.*\.\.\/.*\)'),
    "Insecure_Token_Generation": re.compile(r'Math\.random\s*\(\)'),
    "Dangerous_Permission_Level": re.compile(r'fs\.chmod\s*\(.*\)'),
    "Redirects": re.compile(r'res\.redirect\s*\(.*req\.query\..*\)'),
    "API_Key_Hardcoded": re.compile(r'api_key\s*=\s*[\'"].*[\'"]'),
    "Weak_Hashing_Algorithm": re.compile(r'(md5|sha1|des)\s*\('),
    "Planetext_Credentials": re.compile(r'(username|password)\s*=\s*[\'"].*[\'"]'),
    "Insecure_SSL_Config": re.compile(r'server\.listen\s*\(.*http.*\)'),
    "HTTP_Called": re.compile(r'http\.get\s*\(.*\)'),
    "Sensitive_Data_Logging": re.compile(r'console\.(log|debug|error|warn)\s*\(.*(password|secret|key|token).*\)'),
    "JSON_Parsing_No_Validation": re.compile(r'JSON\.parse\s*\(.*req\.(body|query|params).*\)'),
    "Environment_Variables_In_Planetext": re.compile(r'process\.env\.[a-zA-Z_][a-zA-Z0-9_]*\s*=\s*[\'"].+[\'"]'),
    "Debug_Left_Exposed": re.compile(r'app\.get\s*\([\'"].*debug.*[\'"],.*\)'),
    "Insecure_File_Paths": re.compile(r'(fs\.(readFile|writeFile))\s*\(.*req\.(body|query|params)\.path.*\)'),
    "Unsecured_Spawn": re.compile(r'spawn\s*\(.*\)'),
    # add more patterns, add vulnerability scanning for other files except javascript, like for python,
    # sql, json, txt, docx, jpg, jpeg, png, excel, ppt, ms ki saari files, .gitignore, yaml, yml
}

# Python-specific patterns
Python_Patterns = {
    "Eval_Function": re.compile(r'eval\s*\(.*\)'),
    "Exec_Function": re.compile(r'exec\s*\(.*\)'),
    "OS_Command_Injection": re.compile(r'os\.(system|popen)\s*\(.*\)'),
    "Subprocess_Injection": re.compile(r'subprocess\.(Popen|call|run)\s*\(.*\)'),
    "Pickle_Load": re.compile(r'pickle\.load\s*\(.*\)'),
    "Hardcoded_Credentials": re.compile(r'(username|password)\s*=\s*[\'"].*[\'\"]'),
    "Weak_Hashing_Algorithm": re.compile(r'(md5|sha1|des)\s*\('),
    "Insecure_Random": re.compile(r'random\.randint\s*\(.*\)'),
    "Unverified_SSL": re.compile(r'requests\.get\s*\(.*verify\s*=\s*False\)'),
    "Dangerous_File_Access": re.compile(r'open\s*\(.*\)'),
    "Environment_Variables_Exposure": re.compile(r'os\.environ\[\s*[\'"].+[\'\"]\s*\]'),
    "Debug_Logging": re.compile(r'print\s*\(.*(password|secret|key|token).*[\)]'),
    "Deserialization_Risk": re.compile(r'json\.loads\s*\(.*\)'),
    "Unsecured_Spawn": re.compile(r'os\.spawn\s*\(.*\)')
}
# Define Vulnerability Patterns for Word files
Word_Patterns = {
    "Hardcoded_Credentials": re.compile(r'(username|password)\s*=\s*[\'"].*[\'"]'),
    "Sensitive_Keywords": re.compile(r'(confidential|private|classified|top secret)', re.IGNORECASE),
    "Email_Addresses": re.compile(r'[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+'),
    "Phone_Numbers": re.compile(r'\b(?:\+\d{1,3})?[-.\s]?(\d{2,4})?[-.\s]?\d{3}[-.\s]?\d{4}\b'),
    "URLs": re.compile(r'http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\(\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+')
}

# Analyze File for Vulnerabilities
def AnalyseFile(FileLocation, patterns):
    vulnerabilities = {key: [] for key in patterns.keys()}

    try:
        with open(FileLocation, 'r', encoding='utf-8') as file:
            Data = file.read()
    except Exception as e:
        # changed the line below
        print(f"{Colour.RED}Error reading file {FileLocation}: {e}{Colour.NORMAL}")
        return None

    for key, pattern in patterns.items():
        matches = pattern.findall(Data)
        if matches:
            vulnerabilities[key].extend(matches)

    return vulnerabilities

# Function to analyze a Word file for vulnerabilities
def AnalyseWordFile(FileLocation):
    vulnerabilities = {key: [] for key in Word_Patterns.keys()}
    try:
        doc = docx.Document(FileLocation)
        text_data = "\n".join([para.text for para in doc.paragraphs])
    except Exception as e:
        print(f"Error reading file {FileLocation}: {e}")
        return None
    
    for key, pattern in Word_Patterns.items():
        matches = pattern.findall(text_data)
        if matches:
            vulnerabilities[key].extend(matches)
    
    return vulnerabilities

# Get the list of modified (pushed) files from GitHub Actions environment
def get_modified_files():
    return os.getenv("MODIFIED_FILES", "").split()

# Print Results in a Box
def PrintOutcome(Data):
    Outside = max(len(line) for line in Data.splitlines()) + 4
    print('|' + '-' * (Outside - 2) + '|')
    for line in Data.splitlines():
        print(f"| {line.ljust(Outside - 4)} |")
    print('|' + '-' * (Outside - 2) + '|')

# Main Execution
def main():
    modified_files = get_modified_files()

    if not modified_files:
        print(f"{Colour.RED}No modified files detected.{Colour.NORMAL}")
        return

    for file in modified_files:
        if not os.path.exists(file):
            print(f"{Colour.RED}File not found: {file}{Colour.NORMAL}")
            continue

        print(f"{Colour.YELLOW}Detected new file: {file}{Colour.NORMAL}")

        # Check file type
        if file.endswith(".js"):
            print(f"{Colour.BLUE}Scanning {file} for vulnerabilities...{Colour.NORMAL}")
            patterns = JS_Patterns
            vulnerabilities = AnalyseFile(file, patterns)

            if vulnerabilities and any(vulnerabilities.values()):
                Outcome = f"{Colour.RED}Potential Vulnerability Found in {file}:{Colour.NORMAL}\n"
                for key, found in vulnerabilities.items():
                    if found:
                        Outcome += f"{Colour.V_PATTERN_NAME} {key.replace('_', ' ').title()} vulnerabilities:{Colour.NORMAL}\n"
                        for q in found:
                            Outcome += f"    - {q}\n"
            else:
                Outcome = f"{Colour.GREEN}No vulnerabilities found in {file}.{Colour.NORMAL}"

            PrintOutcome(Outcome)
        
        elif file.endswith(".py"):
            print(f"{Colour.BLUE}Scanning {file} for vulnerabilities...{Colour.NORMAL}")
            patterns = Python_Patterns
            vulnerabilities = AnalyseFile(file, patterns)
            if vulnerabilities and any(vulnerabilities.values()):
                Outcome = f"{Colour.RED}Potential Vulnerability Found in {file}:{Colour.NORMAL}\n"
                for key, found in vulnerabilities.items():
                    if found:
                        Outcome += f"{Colour.V_PATTERN_NAME} {key.replace('_', ' ').title()} vulnerabilities:{Colour.NORMAL}\n"
                        for q in found:
                            Outcome += f"    - {q}\n"
            else:
                Outcome = f"{Colour.GREEN}No vulnerabilities found in {file}.{Colour.NORMAL}"
            PrintOutcome(Outcome)

        elif file.endswith(".docx"):
            print(f"{Colour.BLUE}Scanning {file} for vulnerabilities...{Colour.NORMAL}")
            vulnerabilities = AnalyseWordFile(file)

            if vulnerabilities and any(vulnerabilities.values()):
                Outcome = f"{Colour.RED}Potential Vulnerability Found in {file}:{Colour.NORMAL}\n"
                for key, found in vulnerabilities.items():
                    if found:
                        Outcome += f"{Colour.V_PATTERN_NAME} {key.replace('_', ' ').title()} vulnerabilities:{Colour.NORMAL}\n"
                        for q in found:
                            Outcome += f"    - {q}\n"
            else:
                Outcome = f"{Colour.GREEN}No vulnerabilities found in {file}.{Colour.NORMAL}"
            PrintOutcome(Outcome)

        else:
            print(f"{Colour.RED}{file} is not a JavaScript, Python or Word file. Skipping...{Colour.NORMAL}")

if __name__ == "__main__":
        main()